<!DOCTYPE html>
<html>
<head>
    <title>Watch Inventory</title>
    <link rel="stylesheet" href="https://ly62-dev.github.io/watchinventory/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap">
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Function to generate a unique Watch ID
            function generateWatchID() {
                return 'WID-' + Date.now(); // Uses timestamp for uniqueness
            }
            // Set watch ID on page load
            document.getElementById('watchID').value = generateWatchID();
            
            // Fetch categories and statuses dynamically from JSON file
            fetch("watchInventoryDropdown.json")
            .then(response => response.json())
            .then(data => {
                const movementSelect = document.getElementById("movement");
                const statusSelect = document.getElementById("status");
                const brandSelect = document.getElementById("brand");

                // Keep a default empty option for each dropdown
                movementSelect.innerHTML = `<option value="" selected disabled>Select movement...</option>`;
                statusSelect.innerHTML = `<option value="" selected disabled>Select status...</option>`;
                brandSelect.innerHTML = `<option value="" selected disabled>Select brand...</option>`;
                
                // Populate Movement Dropdown
                data.movements.forEach(movement => {
                    let option = document.createElement("option");
                    option.value = movement;
                    option.textContent = movement;
                    movementSelect.appendChild(option);
                });

                // Populate Status Dropdown
                data.statuses.forEach(status => {
                    let option = document.createElement("option");
                    option.value = status;
                    option.textContent = status;
                    statusSelect.appendChild(option);
                });

                // Populate Brand Dropdown
                data.brands.forEach(brand => {
                    let option = document.createElement("option");
                    option.value = brand;
                    option.textContent = brand;
                    brandSelect.appendChild(option);
                });
            })
            .catch(error => console.error("Dropdown Fetch Error:", error));

            document.getElementById('inventoryForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const watchID = document.getElementById('watchID').value; // Auto-generated Watch ID
                const status = document.getElementById('status').value; // Get status value
                const brand = document.getElementById('brand').value; // Get brand value
                const model = document.getElementById('model').value;
                const movement = document.getElementById('movement').value; // Get movement value
                const qty = document.getElementById('qty').value;
                const boughtPrice = document.getElementById('boughtPrice').value; // New Selling Price Field
                const boughtDate = document.getElementById('boughtDate').value; // New Bought Date Field
                const sellingPrice = document.getElementById('sellingPrice').value; // New Selling Price Field
                const supplier = document.getElementById('supplier').value; // New supplier Field
                const notes = document.getElementById('notes').value; // New Notes Field
                
                const imageFiles = document.getElementById('images').files; // Supports multiple files

                let imagesData = []; // Store multiple images

                const readFile = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => resolve(reader.result.split(",")[1]); // Remove metadata
                    });
                };

                for (let file of imageFiles) {
                    imagesData.push(await readFile(file)); // Convert each image to Base64
                }
                
                fetch('https://script.google.com/macros/s/AKfycbwk3xP_xCPYOGFg1oX0dC5Dv0wDzLGmyVoONgLLCFYFxNsGeMVMV1RfGlViffxUY5Fi/exec', {
                    method: 'POST',
                    mode: 'cors', 
                    redirect: "follow",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ watchID, status, brand, model, movement, qty,boughtPrice,boughtDate,sellingPrice,supplier,notes, images: imagesData })
                })
                .then(response => response.json())
                .then(data => console.log("Success:", data))
                .catch(error => console.error("Fetch Error:", error));

                //get watch inventory records
                fetch('https://script.google.com/macros/s/AKfycbwk3xP_xCPYOGFg1oX0dC5Dv0wDzLGmyVoONgLLCFYFxNsGeMVMV1RfGlViffxUY5Fi/exec')
                .then(response => response.json())
                .then(data => {
                const tableBody = document.getElementById("inventoryTableBody");

                data.forEach((row, index) => {
                    if (index === 0) return; // Skip header row

                    let tr = document.createElement("tr");
                    row.forEach(cell => {
                        let td = document.createElement("td");
                        td.textContent = cell;
                        tr.appendChild(td);
                        });
                    tableBody.appendChild(tr);
                    });
                })
                .catch(error => console.error("Table Fetch Error:", error));
            });
        });
    </script>
</head>
<body>
    <h2>Watch Inventory</h2>
    
    <form id="inventoryForm">
        <input type="text" id="watchID" placeholder="Watch ID" readonly required /> <!-- Auto-generated Watch ID -->
        <!-- âœ… Dynamic Status Dropdown -->
        <select id="status" required>
            <option value="">Loading statuses...</option>
        </select>
        <!-- âœ… Dynamic Brand Dropdown -->
        <select id="brand" required>
            <option value="">Loading brands...</option>
        </select>
        <input type="text" id="model" placeholder="Model" required />
        <!-- âœ… Dynamic Movement Dropdown -->
        <select id="movement" required>
            <option value="">Loading movements...</option>
        </select>
        <input type="number" id="qty" placeholder="Quantity" />
        <input type="number" id="boughtPrice" placeholder="Bought Price" step="0.01" required /> <!-- New Bought Price Field -->
        <input type="date" id="boughtDate" placeholder="Bought Date" /> <!-- New Bought Date Field -->
        <input type="number" id="sellingPrice" placeholder="Selling Price" step="0.01" /> <!-- New Selling Price Field -->
        <input type="text" id="supplier" placeholder="Supplier" />
        <textarea id="notes" placeholder="Additional Notes" rows="4"></textarea> <!-- New Multi-Text Notes Field -->
        <input type="file" id="images" accept="image/*" multiple />
        <button type="submit">Add</button>
    </form>

    <h2>ðŸ“‹ Inventory Summary</h2>
<table border="1" style="width: 100%; text-align: left;">
    <thead>
        <tr>
            <th>Watch ID</th>
            <th>Status</th>
            <th>Brand</th>
            <th>Model</th>
            <th>Movement</th>
            <th>Quantity</th>
            <th>Bought Price</th>
            <th>Bought Date</th>
            <th>Selling Price</th>
            <th>Supplier</th>
            <th>Notes</th>
        </tr>
    </thead>
    <tbody id="inventoryTableBody">
        <!-- Data will be inserted dynamically -->
    </tbody>
</table>

</body>
</html>
